FROM python:3.12-slim

WORKDIR /app


RUN apt-get update && apt-get install -y --no-install-recommends \
    sqlite3 \
    ffmpeg \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean


COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt


COPY mcp-evolution-api/package.json mcp-evolution-api/package-lock.json* mcp-evolution-api/pnpm-lock.yaml* ./mcp-evolution-api/
WORKDIR /app/mcp-evolution-api
RUN npm install --legacy-peer-deps
WORKDIR /app


COPY mcp-evolution-api/tsconfig.json ./mcp-evolution-api/
COPY mcp-evolution-api/src/ ./mcp-evolution-api/src/
WORKDIR /app/mcp-evolution-api
RUN npm run build
WORKDIR /app


COPY life_os_agent/ ./life_os_agent/
COPY init_db.py ./init_db.py


RUN mkdir -p /data

COPY docker-entrypoint.sh /docker-entrypoint.sh
RUN sed -i 's/\r$//' /docker-entrypoint.sh && chmod +x /docker-entrypoint.sh

COPY scripts/start_agent.sh /start_agent.sh
RUN sed -i 's/\r$//' /start_agent.sh && chmod +x /start_agent.sh

ENV PYTHONPATH=/app
ENV DB_PATH=/app/life_os_agent/database/lifeos.db

ENTRYPOINT ["/docker-entrypoint.sh"]
CMD ["/start_agent.sh"]
