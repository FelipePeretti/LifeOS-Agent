FROM python:3.12-slim

WORKDIR /app

# ============================================
# LAYER 1: Dependências do sistema (muda RARAMENTE)
# ============================================
RUN apt-get update && apt-get install -y --no-install-recommends \
    sqlite3 \
    ffmpeg \
    curl \
    gnupg \
    && curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# ============================================
# LAYER 2: Dependências Python (muda POUCO)
# Copiamos só o requirements.txt primeiro para usar cache
# ============================================
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# ============================================
# LAYER 3: Dependências Node.js do MCP (muda POUCO)
# Copiamos só package*.json primeiro para usar cache do npm
# ============================================
COPY mcp-evolution-api/package.json mcp-evolution-api/package-lock.json* mcp-evolution-api/pnpm-lock.yaml* ./mcp-evolution-api/
WORKDIR /app/mcp-evolution-api
RUN npm install --legacy-peer-deps
WORKDIR /app

# ============================================
# LAYER 4: Build do MCP Server (muda quando TS muda)
# ============================================
COPY mcp-evolution-api/tsconfig.json ./mcp-evolution-api/
COPY mcp-evolution-api/src/ ./mcp-evolution-api/src/
WORKDIR /app/mcp-evolution-api
RUN npm run build
WORKDIR /app

# ============================================
# LAYER 5: Código Python (muda FREQUENTEMENTE)
# Esta layer é reconstruída mais vezes, mas é rápida
# ============================================
COPY life_os_agent/ ./life_os_agent/

# ============================================
# LAYER 6: Scripts e configurações finais
# ============================================
RUN mkdir -p /data

COPY docker-entrypoint.sh /docker-entrypoint.sh
RUN sed -i 's/\r$//' /docker-entrypoint.sh && chmod +x /docker-entrypoint.sh

COPY scripts/start_agent.sh /start_agent.sh
RUN sed -i 's/\r$//' /start_agent.sh && chmod +x /start_agent.sh

ENV PYTHONPATH=/app
ENV DB_PATH=/app/life_os_agent/database/lifeos.db

ENTRYPOINT ["/docker-entrypoint.sh"]
CMD ["/start_agent.sh"]

