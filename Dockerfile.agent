FROM python:3.12-slim

WORKDIR /app

# ============================================
# LAYER 1: Dependências do sistema (muda RARAMENTE)
# ============================================
RUN apt-get update && apt-get install -y --no-install-recommends \
    sqlite3 \
    ffmpeg \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# ============================================
# LAYER 2: Dependências Python (muda POUCO)
# Copiamos só o requirements.txt primeiro para usar cache
# ============================================
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# ============================================
# LAYER 3: Código Python (muda FREQUENTEMENTE)
# ============================================
COPY life_os_agent/ ./life_os_agent/
COPY init_db.py ./init_db.py

# ============================================
# LAYER 4: Scripts e configurações finais
# ============================================
RUN mkdir -p /data

COPY docker-entrypoint.sh /docker-entrypoint.sh
RUN sed -i 's/\r$//' /docker-entrypoint.sh && chmod +x /docker-entrypoint.sh

COPY scripts/start_agent.sh /start_agent.sh
RUN sed -i 's/\r$//' /start_agent.sh && chmod +x /start_agent.sh

ENV PYTHONPATH=/app
ENV DB_PATH=/app/life_os_agent/database/lifeos.db

ENTRYPOINT ["/docker-entrypoint.sh"]
CMD ["/start_agent.sh"]
